<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>比特币源码解读之区块确认 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="比特币源码解读之区块确认" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="(本文使用的是比特币v0.1.0版本&nbsp;点击下载源码) 区块重复性检查 区块是否在区块链中，如果在则返回失败 区块是否在孤立区块中，如果在则返回失败 区块基本检查 检查区块大小、时间戳 检查交易、PoW和MerkleRoot 根据区块前一区块进行处理 如果前一区块不存在区块链中，则将前一区块加入孤立区块 如果前一区块不存在区块链中，则尝试接受区块 接受区块 处理孤立区块和当前区块的关系，并尝试接受孤立区块 本文主要描述矿工挖到区块或者收到“block”消息后进行的区块处理。主要包含区块有效性检查，孤立区块处理以及当前区块处理等（ps：本文暂不涉及工作量证明以及共识， 这两方面内容再后续文章中介绍）流程图如下所示： 本文主要描述bool ProcessBlock(CNode&nbsp;pfrom, CBlock&nbsp;pblock)函数的功能。 区块重复性检查 区块是否在区块链中，如果在则返回失败 uint256 hash = GetHash(); if (mapBlockIndex.count(hash)) return error(&quot;AcceptBlock() : block already in mapBlockIndex&quot;); 区块是否在孤立区块中，如果在则返回失败 if (mapOrphanBlocks.count(hash)) return error(&quot;ProcessBlock() : already have block (orphan) %s&quot;, hash.ToString().substr(0,14).c_str()); 区块基本检查 if (!pblock-&gt;CheckBlock()) { delete pblock; return error(&quot;ProcessBlock() : CheckBlock FAILED&quot;); } 检查区块大小、时间戳 // Size limits if (vtx.empty() || vtx.size() &gt; MAX_SIZE || ::GetSerializeSize(*this, SER_DISK) &gt; MAX_SIZE) return error(&quot;CheckBlock() : size limits failed&quot;); // Check timestamp if (nTime &gt; GetAdjustedTime() + 2 * 60 * 60) return error(&quot;CheckBlock() : block timestamp too far in the future&quot;); 检查交易、PoW和MerkleRoot // First transaction must be coinbase, the rest must not be if (vtx.empty() || !vtx[0].IsCoinBase()) return error(&quot;CheckBlock() : first tx is not coinbase&quot;); for (int i = 1; i &lt; vtx.size(); i++) if (vtx[i].IsCoinBase()) return error(&quot;CheckBlock() : more than one coinbase&quot;); // Check transactions foreach(const CTransaction&amp; tx, vtx) if (!tx.CheckTransaction()) return error(&quot;CheckBlock() : CheckTransaction failed&quot;); // Check proof of work matches claimed amount if (CBigNum().SetCompact(nBits) &gt; bnProofOfWorkLimit) return error(&quot;CheckBlock() : nBits below minimum work&quot;); if (GetHash() &gt; CBigNum().SetCompact(nBits).getuint256()) return error(&quot;CheckBlock() : hash doesn&#39;t match nBits&quot;); // Check merkleroot if (hashMerkleRoot != BuildMerkleTree()) return error(&quot;CheckBlock() : hashMerkleRoot mismatch&quot;); 根据区块前一区块进行处理 如果前一区块不存在区块链中，则将前一区块加入孤立区块 此种情况，表示区块链出现分叉或者网络延迟导致的，则需要发送“getblocks”获取最长链中缺少的区块信息。 if (!mapBlockIndex.count(pblock-&gt;hashPrevBlock)) { printf(&quot;ProcessBlock: ORPHAN BLOCK, prev=%s\n&quot;, pblock-&gt;hashPrevBlock.ToString().substr(0,14).c_str()); mapOrphanBlocks.insert(make_pair(hash, pblock)); mapOrphanBlocksByPrev.insert(make_pair(pblock-&gt;hashPrevBlock, pblock)); // Ask this guy to fill in what we&#39;re missing if (pfrom) pfrom-&gt;PushMessage(&quot;getblocks&quot;, CBlockLocator(pindexBest), GetOrphanRoot(pblock)); return true; } 如果前一区块不存在区块链中，则尝试接受区块 if (!pblock-&gt;AcceptBlock()) { delete pblock; return error(&quot;ProcessBlock() : AcceptBlock FAILED&quot;); } delete pblock; 接受区块 “接受区块”包含区块重复性检查，前一区块有效性区块，时间戳检查，工作量证明；当这些条件检查通过后，将区块写入磁盘并加入到区块链中。（加入到区块链具体在后续“比特币源码解读之共识”一文中介绍） bool CBlock::AcceptBlock() { // Check for duplicate uint256 hash = GetHash(); if (mapBlockIndex.count(hash)) // 当前区块重复性检查 return error(&quot;AcceptBlock() : block already in mapBlockIndex&quot;); // Get prev block index map&lt;uint256, CBlockIndex*&gt;::iterator mi = mapBlockIndex.find(hashPrevBlock); if (mi == mapBlockIndex.end()) // 前一区块有效性检查 return error(&quot;AcceptBlock() : prev block not found&quot;); CBlockIndex* pindexPrev = (*mi).second; // Check timestamp against prev if (nTime &lt;= pindexPrev-&gt;GetMedianTimePast()) // 时间戳检查 return error(&quot;AcceptBlock() : block&#39;s timestamp is too early&quot;); // Check proof of work if (nBits != GetNextWorkRequired(pindexPrev)) // 工作量检查 return error(&quot;AcceptBlock() : incorrect proof of work&quot;); // Write block to history file unsigned int nFile; unsigned int nBlockPos; if (!WriteToDisk(!fClient, nFile, nBlockPos)) // 区块写入磁盘中 return error(&quot;AcceptBlock() : WriteToDisk failed&quot;); if (!AddToBlockIndex(nFile, nBlockPos)) // 加入到区块链中 return error(&quot;AcceptBlock() : AddToBlockIndex failed&quot;); if (hashBestChain == hash) // 如果该区块链式最长链，则广播消息 RelayInventory(CInv(MSG_BLOCK, hash)); return true; } 处理孤立区块和当前区块的关系，并尝试接受孤立区块 vector&lt;uint256&gt; vWorkQueue; vWorkQueue.push_back(hash); for (int i = 0; i &lt; vWorkQueue.size(); i++) { uint256 hashPrev = vWorkQueue[i]; for (multimap&lt;uint256, CBlock*&gt;::iterator mi = mapOrphanBlocksByPrev.lower_bound(hashPrev); mi != mapOrphanBlocksByPrev.upper_bound(hashPrev); ++mi) { CBlock* pblockOrphan = (*mi).second; if (pblockOrphan-&gt;AcceptBlock()) // 尝试接受孤立区块 vWorkQueue.push_back(pblockOrphan-&gt;GetHash()); mapOrphanBlocks.erase(pblockOrphan-&gt;GetHash()); delete pblockOrphan; } mapOrphanBlocksByPrev.erase(hashPrev); } 上一篇：&nbsp;比特币源码解读之选币 下一篇：比特币源码解读之工作量证明 版权声明：B链网原创，严禁修改。转载请注明作者和原文链接 作者：雨后的蚊子 原文链接：http://www.360bchain.com/article/130.html 阅读更多" />
<meta property="og:description" content="(本文使用的是比特币v0.1.0版本&nbsp;点击下载源码) 区块重复性检查 区块是否在区块链中，如果在则返回失败 区块是否在孤立区块中，如果在则返回失败 区块基本检查 检查区块大小、时间戳 检查交易、PoW和MerkleRoot 根据区块前一区块进行处理 如果前一区块不存在区块链中，则将前一区块加入孤立区块 如果前一区块不存在区块链中，则尝试接受区块 接受区块 处理孤立区块和当前区块的关系，并尝试接受孤立区块 本文主要描述矿工挖到区块或者收到“block”消息后进行的区块处理。主要包含区块有效性检查，孤立区块处理以及当前区块处理等（ps：本文暂不涉及工作量证明以及共识， 这两方面内容再后续文章中介绍）流程图如下所示： 本文主要描述bool ProcessBlock(CNode&nbsp;pfrom, CBlock&nbsp;pblock)函数的功能。 区块重复性检查 区块是否在区块链中，如果在则返回失败 uint256 hash = GetHash(); if (mapBlockIndex.count(hash)) return error(&quot;AcceptBlock() : block already in mapBlockIndex&quot;); 区块是否在孤立区块中，如果在则返回失败 if (mapOrphanBlocks.count(hash)) return error(&quot;ProcessBlock() : already have block (orphan) %s&quot;, hash.ToString().substr(0,14).c_str()); 区块基本检查 if (!pblock-&gt;CheckBlock()) { delete pblock; return error(&quot;ProcessBlock() : CheckBlock FAILED&quot;); } 检查区块大小、时间戳 // Size limits if (vtx.empty() || vtx.size() &gt; MAX_SIZE || ::GetSerializeSize(*this, SER_DISK) &gt; MAX_SIZE) return error(&quot;CheckBlock() : size limits failed&quot;); // Check timestamp if (nTime &gt; GetAdjustedTime() + 2 * 60 * 60) return error(&quot;CheckBlock() : block timestamp too far in the future&quot;); 检查交易、PoW和MerkleRoot // First transaction must be coinbase, the rest must not be if (vtx.empty() || !vtx[0].IsCoinBase()) return error(&quot;CheckBlock() : first tx is not coinbase&quot;); for (int i = 1; i &lt; vtx.size(); i++) if (vtx[i].IsCoinBase()) return error(&quot;CheckBlock() : more than one coinbase&quot;); // Check transactions foreach(const CTransaction&amp; tx, vtx) if (!tx.CheckTransaction()) return error(&quot;CheckBlock() : CheckTransaction failed&quot;); // Check proof of work matches claimed amount if (CBigNum().SetCompact(nBits) &gt; bnProofOfWorkLimit) return error(&quot;CheckBlock() : nBits below minimum work&quot;); if (GetHash() &gt; CBigNum().SetCompact(nBits).getuint256()) return error(&quot;CheckBlock() : hash doesn&#39;t match nBits&quot;); // Check merkleroot if (hashMerkleRoot != BuildMerkleTree()) return error(&quot;CheckBlock() : hashMerkleRoot mismatch&quot;); 根据区块前一区块进行处理 如果前一区块不存在区块链中，则将前一区块加入孤立区块 此种情况，表示区块链出现分叉或者网络延迟导致的，则需要发送“getblocks”获取最长链中缺少的区块信息。 if (!mapBlockIndex.count(pblock-&gt;hashPrevBlock)) { printf(&quot;ProcessBlock: ORPHAN BLOCK, prev=%s\n&quot;, pblock-&gt;hashPrevBlock.ToString().substr(0,14).c_str()); mapOrphanBlocks.insert(make_pair(hash, pblock)); mapOrphanBlocksByPrev.insert(make_pair(pblock-&gt;hashPrevBlock, pblock)); // Ask this guy to fill in what we&#39;re missing if (pfrom) pfrom-&gt;PushMessage(&quot;getblocks&quot;, CBlockLocator(pindexBest), GetOrphanRoot(pblock)); return true; } 如果前一区块不存在区块链中，则尝试接受区块 if (!pblock-&gt;AcceptBlock()) { delete pblock; return error(&quot;ProcessBlock() : AcceptBlock FAILED&quot;); } delete pblock; 接受区块 “接受区块”包含区块重复性检查，前一区块有效性区块，时间戳检查，工作量证明；当这些条件检查通过后，将区块写入磁盘并加入到区块链中。（加入到区块链具体在后续“比特币源码解读之共识”一文中介绍） bool CBlock::AcceptBlock() { // Check for duplicate uint256 hash = GetHash(); if (mapBlockIndex.count(hash)) // 当前区块重复性检查 return error(&quot;AcceptBlock() : block already in mapBlockIndex&quot;); // Get prev block index map&lt;uint256, CBlockIndex*&gt;::iterator mi = mapBlockIndex.find(hashPrevBlock); if (mi == mapBlockIndex.end()) // 前一区块有效性检查 return error(&quot;AcceptBlock() : prev block not found&quot;); CBlockIndex* pindexPrev = (*mi).second; // Check timestamp against prev if (nTime &lt;= pindexPrev-&gt;GetMedianTimePast()) // 时间戳检查 return error(&quot;AcceptBlock() : block&#39;s timestamp is too early&quot;); // Check proof of work if (nBits != GetNextWorkRequired(pindexPrev)) // 工作量检查 return error(&quot;AcceptBlock() : incorrect proof of work&quot;); // Write block to history file unsigned int nFile; unsigned int nBlockPos; if (!WriteToDisk(!fClient, nFile, nBlockPos)) // 区块写入磁盘中 return error(&quot;AcceptBlock() : WriteToDisk failed&quot;); if (!AddToBlockIndex(nFile, nBlockPos)) // 加入到区块链中 return error(&quot;AcceptBlock() : AddToBlockIndex failed&quot;); if (hashBestChain == hash) // 如果该区块链式最长链，则广播消息 RelayInventory(CInv(MSG_BLOCK, hash)); return true; } 处理孤立区块和当前区块的关系，并尝试接受孤立区块 vector&lt;uint256&gt; vWorkQueue; vWorkQueue.push_back(hash); for (int i = 0; i &lt; vWorkQueue.size(); i++) { uint256 hashPrev = vWorkQueue[i]; for (multimap&lt;uint256, CBlock*&gt;::iterator mi = mapOrphanBlocksByPrev.lower_bound(hashPrev); mi != mapOrphanBlocksByPrev.upper_bound(hashPrev); ++mi) { CBlock* pblockOrphan = (*mi).second; if (pblockOrphan-&gt;AcceptBlock()) // 尝试接受孤立区块 vWorkQueue.push_back(pblockOrphan-&gt;GetHash()); mapOrphanBlocks.erase(pblockOrphan-&gt;GetHash()); delete pblockOrphan; } mapOrphanBlocksByPrev.erase(hashPrev); } 上一篇：&nbsp;比特币源码解读之选币 下一篇：比特币源码解读之工作量证明 版权声明：B链网原创，严禁修改。转载请注明作者和原文链接 作者：雨后的蚊子 原文链接：http://www.360bchain.com/article/130.html 阅读更多" />
<link rel="canonical" href="http://0.0.0.0:4000/2018/05/21/%E6%AF%94%E7%89%B9%E5%B8%81%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%E4%B9%8B%E5%8C%BA%E5%9D%97%E7%A1%AE%E8%AE%A4.html" />
<meta property="og:url" content="http://0.0.0.0:4000/2018/05/21/%E6%AF%94%E7%89%B9%E5%B8%81%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%E4%B9%8B%E5%8C%BA%E5%9D%97%E7%A1%AE%E8%AE%A4.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-05-21T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"(本文使用的是比特币v0.1.0版本&nbsp;点击下载源码) 区块重复性检查 区块是否在区块链中，如果在则返回失败 区块是否在孤立区块中，如果在则返回失败 区块基本检查 检查区块大小、时间戳 检查交易、PoW和MerkleRoot 根据区块前一区块进行处理 如果前一区块不存在区块链中，则将前一区块加入孤立区块 如果前一区块不存在区块链中，则尝试接受区块 接受区块 处理孤立区块和当前区块的关系，并尝试接受孤立区块 本文主要描述矿工挖到区块或者收到“block”消息后进行的区块处理。主要包含区块有效性检查，孤立区块处理以及当前区块处理等（ps：本文暂不涉及工作量证明以及共识， 这两方面内容再后续文章中介绍）流程图如下所示： 本文主要描述bool ProcessBlock(CNode&nbsp;pfrom, CBlock&nbsp;pblock)函数的功能。 区块重复性检查 区块是否在区块链中，如果在则返回失败 uint256 hash = GetHash(); if (mapBlockIndex.count(hash)) return error(&quot;AcceptBlock() : block already in mapBlockIndex&quot;); 区块是否在孤立区块中，如果在则返回失败 if (mapOrphanBlocks.count(hash)) return error(&quot;ProcessBlock() : already have block (orphan) %s&quot;, hash.ToString().substr(0,14).c_str()); 区块基本检查 if (!pblock-&gt;CheckBlock()) { delete pblock; return error(&quot;ProcessBlock() : CheckBlock FAILED&quot;); } 检查区块大小、时间戳 // Size limits if (vtx.empty() || vtx.size() &gt; MAX_SIZE || ::GetSerializeSize(*this, SER_DISK) &gt; MAX_SIZE) return error(&quot;CheckBlock() : size limits failed&quot;); // Check timestamp if (nTime &gt; GetAdjustedTime() + 2 * 60 * 60) return error(&quot;CheckBlock() : block timestamp too far in the future&quot;); 检查交易、PoW和MerkleRoot // First transaction must be coinbase, the rest must not be if (vtx.empty() || !vtx[0].IsCoinBase()) return error(&quot;CheckBlock() : first tx is not coinbase&quot;); for (int i = 1; i &lt; vtx.size(); i++) if (vtx[i].IsCoinBase()) return error(&quot;CheckBlock() : more than one coinbase&quot;); // Check transactions foreach(const CTransaction&amp; tx, vtx) if (!tx.CheckTransaction()) return error(&quot;CheckBlock() : CheckTransaction failed&quot;); // Check proof of work matches claimed amount if (CBigNum().SetCompact(nBits) &gt; bnProofOfWorkLimit) return error(&quot;CheckBlock() : nBits below minimum work&quot;); if (GetHash() &gt; CBigNum().SetCompact(nBits).getuint256()) return error(&quot;CheckBlock() : hash doesn&#39;t match nBits&quot;); // Check merkleroot if (hashMerkleRoot != BuildMerkleTree()) return error(&quot;CheckBlock() : hashMerkleRoot mismatch&quot;); 根据区块前一区块进行处理 如果前一区块不存在区块链中，则将前一区块加入孤立区块 此种情况，表示区块链出现分叉或者网络延迟导致的，则需要发送“getblocks”获取最长链中缺少的区块信息。 if (!mapBlockIndex.count(pblock-&gt;hashPrevBlock)) { printf(&quot;ProcessBlock: ORPHAN BLOCK, prev=%s\\n&quot;, pblock-&gt;hashPrevBlock.ToString().substr(0,14).c_str()); mapOrphanBlocks.insert(make_pair(hash, pblock)); mapOrphanBlocksByPrev.insert(make_pair(pblock-&gt;hashPrevBlock, pblock)); // Ask this guy to fill in what we&#39;re missing if (pfrom) pfrom-&gt;PushMessage(&quot;getblocks&quot;, CBlockLocator(pindexBest), GetOrphanRoot(pblock)); return true; } 如果前一区块不存在区块链中，则尝试接受区块 if (!pblock-&gt;AcceptBlock()) { delete pblock; return error(&quot;ProcessBlock() : AcceptBlock FAILED&quot;); } delete pblock; 接受区块 “接受区块”包含区块重复性检查，前一区块有效性区块，时间戳检查，工作量证明；当这些条件检查通过后，将区块写入磁盘并加入到区块链中。（加入到区块链具体在后续“比特币源码解读之共识”一文中介绍） bool CBlock::AcceptBlock() { // Check for duplicate uint256 hash = GetHash(); if (mapBlockIndex.count(hash)) // 当前区块重复性检查 return error(&quot;AcceptBlock() : block already in mapBlockIndex&quot;); // Get prev block index map&lt;uint256, CBlockIndex*&gt;::iterator mi = mapBlockIndex.find(hashPrevBlock); if (mi == mapBlockIndex.end()) // 前一区块有效性检查 return error(&quot;AcceptBlock() : prev block not found&quot;); CBlockIndex* pindexPrev = (*mi).second; // Check timestamp against prev if (nTime &lt;= pindexPrev-&gt;GetMedianTimePast()) // 时间戳检查 return error(&quot;AcceptBlock() : block&#39;s timestamp is too early&quot;); // Check proof of work if (nBits != GetNextWorkRequired(pindexPrev)) // 工作量检查 return error(&quot;AcceptBlock() : incorrect proof of work&quot;); // Write block to history file unsigned int nFile; unsigned int nBlockPos; if (!WriteToDisk(!fClient, nFile, nBlockPos)) // 区块写入磁盘中 return error(&quot;AcceptBlock() : WriteToDisk failed&quot;); if (!AddToBlockIndex(nFile, nBlockPos)) // 加入到区块链中 return error(&quot;AcceptBlock() : AddToBlockIndex failed&quot;); if (hashBestChain == hash) // 如果该区块链式最长链，则广播消息 RelayInventory(CInv(MSG_BLOCK, hash)); return true; } 处理孤立区块和当前区块的关系，并尝试接受孤立区块 vector&lt;uint256&gt; vWorkQueue; vWorkQueue.push_back(hash); for (int i = 0; i &lt; vWorkQueue.size(); i++) { uint256 hashPrev = vWorkQueue[i]; for (multimap&lt;uint256, CBlock*&gt;::iterator mi = mapOrphanBlocksByPrev.lower_bound(hashPrev); mi != mapOrphanBlocksByPrev.upper_bound(hashPrev); ++mi) { CBlock* pblockOrphan = (*mi).second; if (pblockOrphan-&gt;AcceptBlock()) // 尝试接受孤立区块 vWorkQueue.push_back(pblockOrphan-&gt;GetHash()); mapOrphanBlocks.erase(pblockOrphan-&gt;GetHash()); delete pblockOrphan; } mapOrphanBlocksByPrev.erase(hashPrev); } 上一篇：&nbsp;比特币源码解读之选币 下一篇：比特币源码解读之工作量证明 版权声明：B链网原创，严禁修改。转载请注明作者和原文链接 作者：雨后的蚊子 原文链接：http://www.360bchain.com/article/130.html 阅读更多","@type":"BlogPosting","url":"http://0.0.0.0:4000/2018/05/21/%E6%AF%94%E7%89%B9%E5%B8%81%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%E4%B9%8B%E5%8C%BA%E5%9D%97%E7%A1%AE%E8%AE%A4.html","headline":"比特币源码解读之区块确认","dateModified":"2018-05-21T00:00:00+08:00","datePublished":"2018-05-21T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/2018/05/21/%E6%AF%94%E7%89%B9%E5%B8%81%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%E4%B9%8B%E5%8C%BA%E5%9D%97%E7%A1%AE%E8%AE%A4.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>

  </head>
  <body>
    <div class="wrapper">
      <header  class="without-description" >
        <h1>比特币源码解读之区块确认</h1>
        
        
        <ul>
            <li><a href="https://blog.uzzz.org/" target="_blank"><strong>柚子社区<br/>(国际版)</strong></a></li>
            <li><a href="https://blog.uzzz.org.cn/" target="_blank"><strong>柚子社区<br/>(国内版)</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

      <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;text-align:left;"><em>(本文使用的是比特币v0.1.0版本&nbsp;<a href="http://forum.360bchain.com/comments.php?DiscussionID=21" rel="nofollow" title="点击下载源码" style="background-position:0px 0px;color:rgb(65,131,196);">点击下载源码</a>)</em></p>
  <div class="markdown-toc editormd-markdown-toc" style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;text-align:left;">
   <ul class="markdown-toc-list">
    <li><a class="toc-level-1" href="http://www.360bchain.com/article/130.html#%E5%8C%BA%E5%9D%97%E9%87%8D%E5%A4%8D%E6%80%A7%E6%A3%80%E6%9F%A5" rel="nofollow" style="background-position:0px 0px;color:rgb(65,131,196);">区块重复性检查</a>
     <ul>
      <li><a class="toc-level-2" href="http://www.360bchain.com/article/130.html#%E5%8C%BA%E5%9D%97%E6%98%AF%E5%90%A6%E5%9C%A8%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%AD%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%9C%A8%E5%88%99%E8%BF%94%E5%9B%9E%E5%A4%B1%E8%B4%A5" rel="nofollow" style="background-position:0px 0px;color:rgb(65,131,196);">区块是否在区块链中，如果在则返回失败</a></li>
      <li><a class="toc-level-2" href="http://www.360bchain.com/article/130.html#%E5%8C%BA%E5%9D%97%E6%98%AF%E5%90%A6%E5%9C%A8%E5%AD%A4%E7%AB%8B%E5%8C%BA%E5%9D%97%E4%B8%AD%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%9C%A8%E5%88%99%E8%BF%94%E5%9B%9E%E5%A4%B1%E8%B4%A5" rel="nofollow" style="background-position:0px 0px;color:rgb(65,131,196);">区块是否在孤立区块中，如果在则返回失败</a></li>
     </ul></li>
    <li><a class="toc-level-1" href="http://www.360bchain.com/article/130.html#%E5%8C%BA%E5%9D%97%E5%9F%BA%E6%9C%AC%E6%A3%80%E6%9F%A5" rel="nofollow" style="background-position:0px 0px;color:rgb(65,131,196);">区块基本检查</a>
     <ul>
      <li><a class="toc-level-2" href="http://www.360bchain.com/article/130.html#%E6%A3%80%E6%9F%A5%E5%8C%BA%E5%9D%97%E5%A4%A7%E5%B0%8F%E3%80%81%E6%97%B6%E9%97%B4%E6%88%B3" rel="nofollow" style="background-position:0px 0px;color:rgb(65,131,196);">检查区块大小、时间戳</a></li>
      <li><a class="toc-level-2" href="http://www.360bchain.com/article/130.html#%E6%A3%80%E6%9F%A5%E4%BA%A4%E6%98%93%E3%80%81PoW%E5%92%8CMerkleRoot" rel="nofollow" style="background-position:0px 0px;color:rgb(65,131,196);">检查交易、PoW和MerkleRoot</a></li>
     </ul></li>
    <li><a class="toc-level-1" href="http://www.360bchain.com/article/130.html#%E6%A0%B9%E6%8D%AE%E5%8C%BA%E5%9D%97%E5%89%8D%E4%B8%80%E5%8C%BA%E5%9D%97%E8%BF%9B%E8%A1%8C%E5%A4%84%E7%90%86" rel="nofollow" style="background-position:0px 0px;color:rgb(65,131,196);">根据区块前一区块进行处理</a>
     <ul>
      <li><a class="toc-level-2" href="http://www.360bchain.com/article/130.html#%E5%A6%82%E6%9E%9C%E5%89%8D%E4%B8%80%E5%8C%BA%E5%9D%97%E4%B8%8D%E5%AD%98%E5%9C%A8%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%AD%EF%BC%8C%E5%88%99%E5%B0%86%E5%89%8D%E4%B8%80%E5%8C%BA%E5%9D%97%E5%8A%A0%E5%85%A5%E5%AD%A4%E7%AB%8B%E5%8C%BA%E5%9D%97" rel="nofollow" style="background-position:0px 0px;color:rgb(65,131,196);">如果前一区块不存在区块链中，则将前一区块加入孤立区块</a></li>
      <li><a class="toc-level-2" href="http://www.360bchain.com/article/130.html#%E5%A6%82%E6%9E%9C%E5%89%8D%E4%B8%80%E5%8C%BA%E5%9D%97%E4%B8%8D%E5%AD%98%E5%9C%A8%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%AD%EF%BC%8C%E5%88%99%E5%B0%9D%E8%AF%95%E6%8E%A5%E5%8F%97%E5%8C%BA%E5%9D%97" rel="nofollow" style="background-position:0px 0px;color:rgb(65,131,196);">如果前一区块不存在区块链中，则尝试接受区块</a>
       <ul>
        <li><a class="toc-level-3" href="http://www.360bchain.com/article/130.html#%E6%8E%A5%E5%8F%97%E5%8C%BA%E5%9D%97" rel="nofollow" style="background-position:0px 0px;color:rgb(65,131,196);">接受区块</a></li>
        <li><a class="toc-level-3" href="http://www.360bchain.com/article/130.html#%E5%A4%84%E7%90%86%E5%AD%A4%E7%AB%8B%E5%8C%BA%E5%9D%97%E5%92%8C%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E7%9A%84%E5%85%B3%E7%B3%BB%EF%BC%8C%E5%B9%B6%E5%B0%9D%E8%AF%95%E6%8E%A5%E5%8F%97%E5%AD%A4%E7%AB%8B%E5%8C%BA%E5%9D%97" rel="nofollow" style="background-position:0px 0px;color:rgb(65,131,196);">处理孤立区块和当前区块的关系，并尝试接受孤立区块</a></li>
       </ul></li>
     </ul></li>
   </ul>
  </div>
  <p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;text-align:left;">本文主要描述矿工挖到区块或者收到“block”消息后进行的区块处理。主要包含区块有效性检查，孤立区块处理以及当前区块处理等（ps：本文暂不涉及工作量证明以及共识， 这两方面内容再后续文章中介绍）<br>流程图如下所示：<br><img src="http://img.360bchain.com/pictures/TD/5af8322c4dd35.png" alt="" style="border:0px;vertical-align:middle;"></p>
  <p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;text-align:left;"><em>本文主要描述bool ProcessBlock(CNode</em>&nbsp;pfrom, CBlock<em>&nbsp;pblock)函数的功能。</em></p>
  <h1 style="font-size:2.25em;font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;line-height:1.2;color:rgb(51,51,51);border-bottom:1px solid rgb(238,238,238);text-align:left;"><a class="reference-link" style="background-position:0px 0px;color:rgb(65,131,196);"></a>区块重复性检查</h1>
  <h2 style="font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;line-height:1.225;color:rgb(51,51,51);font-size:1.75em;border-bottom:1px solid rgb(238,238,238);text-align:left;"><a class="reference-link" style="background-position:0px 0px;color:rgb(65,131,196);"></a>区块是否在区块链中，如果在则返回失败</h2>
  <pre class="prettyprint linenums prettyprinted" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;line-height:1.6;color:rgb(51,51,51);background:rgb(246,246,246);border-width:1px;border-style:solid;border-color:rgb(221,221,221);text-align:left;"></pre>
  <ol class="linenums" style="color:rgb(153,153,153);">
   <li class="L0"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="typ" style="color:rgb(102,0,102);">uint256</span><span class="pln" style="color:rgb(0,0,0);"> hash </span><span class="pun" style="color:rgb(102,102,0);">=</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="typ" style="color:rgb(102,0,102);">GetHash</span><span class="pun" style="color:rgb(102,102,0);">();</span></code></li>
   <li class="L1" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="kwd" style="color:rgb(0,0,136);">if</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">mapBlockIndex</span><span class="pun" style="color:rgb(102,102,0);">.</span><span class="pln" style="color:rgb(0,0,0);">count</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">hash</span><span class="pun" style="color:rgb(102,102,0);">))</span></code></li>
   <li class="L2"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">return</span><span class="pln" style="color:rgb(0,0,0);"> error</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="str" style="color:rgb(0,136,0);">"AcceptBlock() : block already in mapBlockIndex"</span><span class="pun" style="color:rgb(102,102,0);">);</span></code></li>
  </ol>
  <h2 style="font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;line-height:1.225;color:rgb(51,51,51);font-size:1.75em;border-bottom:1px solid rgb(238,238,238);text-align:left;"><a class="reference-link" style="background-position:0px 0px;color:rgb(65,131,196);"></a>区块是否在孤立区块中，如果在则返回失败</h2>
  <pre class="prettyprint linenums prettyprinted" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;line-height:1.6;color:rgb(51,51,51);background:rgb(246,246,246);border-width:1px;border-style:solid;border-color:rgb(221,221,221);text-align:left;"></pre>
  <ol class="linenums" style="color:rgb(153,153,153);">
   <li class="L0"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="kwd" style="color:rgb(0,0,136);">if</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">mapOrphanBlocks</span><span class="pun" style="color:rgb(102,102,0);">.</span><span class="pln" style="color:rgb(0,0,0);">count</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">hash</span><span class="pun" style="color:rgb(102,102,0);">))</span></code></li>
   <li class="L1" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">return</span><span class="pln" style="color:rgb(0,0,0);"> error</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="str" style="color:rgb(0,136,0);">"ProcessBlock() : already have block (orphan) %s"</span><span class="pun" style="color:rgb(102,102,0);">,</span><span class="pln" style="color:rgb(0,0,0);"> hash</span><span class="pun" style="color:rgb(102,102,0);">.</span><span class="typ" style="color:rgb(102,0,102);">ToString</span><span class="pun" style="color:rgb(102,102,0);">().</span><span class="pln" style="color:rgb(0,0,0);">substr</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="lit" style="color:rgb(0,102,102);">0</span><span class="pun" style="color:rgb(102,102,0);">,</span><span class="lit" style="color:rgb(0,102,102);">14</span><span class="pun" style="color:rgb(102,102,0);">).</span><span class="pln" style="color:rgb(0,0,0);">c_str</span><span class="pun" style="color:rgb(102,102,0);">());</span></code></li>
  </ol>
  <h1 style="font-size:2.25em;font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;line-height:1.2;color:rgb(51,51,51);border-bottom:1px solid rgb(238,238,238);text-align:left;"><a class="reference-link" style="background-position:0px 0px;color:rgb(65,131,196);"></a>区块基本检查</h1>
  <pre class="prettyprint linenums prettyprinted" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;line-height:1.6;color:rgb(51,51,51);background:rgb(246,246,246);border-width:1px;border-style:solid;border-color:rgb(221,221,221);text-align:left;"></pre>
  <ol class="linenums" style="color:rgb(153,153,153);">
   <li class="L0"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="kwd" style="color:rgb(0,0,136);">if</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(!</span><span class="pln" style="color:rgb(0,0,0);">pblock</span><span class="pun" style="color:rgb(102,102,0);">-&gt;</span><span class="typ" style="color:rgb(102,0,102);">CheckBlock</span><span class="pun" style="color:rgb(102,102,0);">())</span></code></li>
   <li class="L1" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pun" style="color:rgb(102,102,0);">{</span></code></li>
   <li class="L2"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">delete</span><span class="pln" style="color:rgb(0,0,0);"> pblock</span><span class="pun" style="color:rgb(102,102,0);">;</span></code></li>
   <li class="L3" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">return</span><span class="pln" style="color:rgb(0,0,0);"> error</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="str" style="color:rgb(0,136,0);">"ProcessBlock() : CheckBlock FAILED"</span><span class="pun" style="color:rgb(102,102,0);">);</span></code></li>
   <li class="L4"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pun" style="color:rgb(102,102,0);">}</span></code></li>
  </ol>
  <h2 style="font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;line-height:1.225;color:rgb(51,51,51);font-size:1.75em;border-bottom:1px solid rgb(238,238,238);text-align:left;"><a class="reference-link" style="background-position:0px 0px;color:rgb(65,131,196);"></a>检查区块大小、时间戳</h2>
  <pre class="prettyprint linenums prettyprinted" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;line-height:1.6;color:rgb(51,51,51);background:rgb(246,246,246);border-width:1px;border-style:solid;border-color:rgb(221,221,221);text-align:left;"></pre>
  <ol class="linenums" style="color:rgb(153,153,153);">
   <li class="L0"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="com" style="color:rgb(136,0,0);">// Size limits</span></code></li>
   <li class="L1" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="kwd" style="color:rgb(0,0,136);">if</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">vtx</span><span class="pun" style="color:rgb(102,102,0);">.</span><span class="pln" style="color:rgb(0,0,0);">empty</span><span class="pun" style="color:rgb(102,102,0);">()</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">||</span><span class="pln" style="color:rgb(0,0,0);"> vtx</span><span class="pun" style="color:rgb(102,102,0);">.</span><span class="pln" style="color:rgb(0,0,0);">size</span><span class="pun" style="color:rgb(102,102,0);">()</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">&gt;</span><span class="pln" style="color:rgb(0,0,0);"> MAX_SIZE </span><span class="pun" style="color:rgb(102,102,0);">||</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">::</span><span class="typ" style="color:rgb(102,0,102);">GetSerializeSize</span><span class="pun" style="color:rgb(102,102,0);">(*</span><span class="kwd" style="color:rgb(0,0,136);">this</span><span class="pun" style="color:rgb(102,102,0);">,</span><span class="pln" style="color:rgb(0,0,0);"> SER_DISK</span><span class="pun" style="color:rgb(102,102,0);">)</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">&gt;</span><span class="pln" style="color:rgb(0,0,0);"> MAX_SIZE</span><span class="pun" style="color:rgb(102,102,0);">)</span></code></li>
   <li class="L2"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">return</span><span class="pln" style="color:rgb(0,0,0);"> error</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="str" style="color:rgb(0,136,0);">"CheckBlock() : size limits failed"</span><span class="pun" style="color:rgb(102,102,0);">);</span></code></li>
   <li class="L3" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"></code></li>
   <li class="L4"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="com" style="color:rgb(136,0,0);">// Check timestamp</span></code></li>
   <li class="L5" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="kwd" style="color:rgb(0,0,136);">if</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">nTime </span><span class="pun" style="color:rgb(102,102,0);">&gt;</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="typ" style="color:rgb(102,0,102);">GetAdjustedTime</span><span class="pun" style="color:rgb(102,102,0);">()</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">+</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="lit" style="color:rgb(0,102,102);">2</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">*</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="lit" style="color:rgb(0,102,102);">60</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">*</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="lit" style="color:rgb(0,102,102);">60</span><span class="pun" style="color:rgb(102,102,0);">)</span></code></li>
   <li class="L6"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">return</span><span class="pln" style="color:rgb(0,0,0);"> error</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="str" style="color:rgb(0,136,0);">"CheckBlock() : block timestamp too far in the future"</span><span class="pun" style="color:rgb(102,102,0);">);</span></code></li>
  </ol>
  <h2 style="font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;line-height:1.225;color:rgb(51,51,51);font-size:1.75em;border-bottom:1px solid rgb(238,238,238);text-align:left;"><a class="reference-link" style="background-position:0px 0px;color:rgb(65,131,196);"></a>检查交易、PoW和MerkleRoot</h2>
  <pre class="prettyprint linenums prettyprinted" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;line-height:1.6;color:rgb(51,51,51);background:rgb(246,246,246);border-width:1px;border-style:solid;border-color:rgb(221,221,221);text-align:left;"></pre>
  <ol class="linenums" style="color:rgb(153,153,153);">
   <li class="L0"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="com" style="color:rgb(136,0,0);">// First transaction must be coinbase, the rest must not be</span></code></li>
   <li class="L1" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="kwd" style="color:rgb(0,0,136);">if</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">vtx</span><span class="pun" style="color:rgb(102,102,0);">.</span><span class="pln" style="color:rgb(0,0,0);">empty</span><span class="pun" style="color:rgb(102,102,0);">()</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">||</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">!</span><span class="pln" style="color:rgb(0,0,0);">vtx</span><span class="pun" style="color:rgb(102,102,0);">[</span><span class="lit" style="color:rgb(0,102,102);">0</span><span class="pun" style="color:rgb(102,102,0);">].</span><span class="typ" style="color:rgb(102,0,102);">IsCoinBase</span><span class="pun" style="color:rgb(102,102,0);">())</span></code></li>
   <li class="L2"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">return</span><span class="pln" style="color:rgb(0,0,0);"> error</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="str" style="color:rgb(0,136,0);">"CheckBlock() : first tx is not coinbase"</span><span class="pun" style="color:rgb(102,102,0);">);</span></code></li>
   <li class="L3" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="kwd" style="color:rgb(0,0,136);">for</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="typ" style="color:rgb(102,0,102);">int</span><span class="pln" style="color:rgb(0,0,0);"> i </span><span class="pun" style="color:rgb(102,102,0);">=</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="lit" style="color:rgb(0,102,102);">1</span><span class="pun" style="color:rgb(102,102,0);">;</span><span class="pln" style="color:rgb(0,0,0);"> i </span><span class="pun" style="color:rgb(102,102,0);">&lt;</span><span class="pln" style="color:rgb(0,0,0);"> vtx</span><span class="pun" style="color:rgb(102,102,0);">.</span><span class="pln" style="color:rgb(0,0,0);">size</span><span class="pun" style="color:rgb(102,102,0);">();</span><span class="pln" style="color:rgb(0,0,0);"> i</span><span class="pun" style="color:rgb(102,102,0);">++)</span></code></li>
   <li class="L4"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">if</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">vtx</span><span class="pun" style="color:rgb(102,102,0);">[</span><span class="pln" style="color:rgb(0,0,0);">i</span><span class="pun" style="color:rgb(102,102,0);">].</span><span class="typ" style="color:rgb(102,0,102);">IsCoinBase</span><span class="pun" style="color:rgb(102,102,0);">())</span></code></li>
   <li class="L5" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">return</span><span class="pln" style="color:rgb(0,0,0);"> error</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="str" style="color:rgb(0,136,0);">"CheckBlock() : more than one coinbase"</span><span class="pun" style="color:rgb(102,102,0);">);</span></code></li>
   <li class="L6"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"></code></li>
   <li class="L7" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="com" style="color:rgb(136,0,0);">// Check transactions</span></code></li>
   <li class="L8"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);">foreach</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="kwd" style="color:rgb(0,0,136);">const</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="typ" style="color:rgb(102,0,102);">CTransaction</span><span class="pun" style="color:rgb(102,102,0);">&amp;</span><span class="pln" style="color:rgb(0,0,0);"> tx</span><span class="pun" style="color:rgb(102,102,0);">,</span><span class="pln" style="color:rgb(0,0,0);"> vtx</span><span class="pun" style="color:rgb(102,102,0);">)</span></code></li>
   <li class="L9" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">if</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(!</span><span class="pln" style="color:rgb(0,0,0);">tx</span><span class="pun" style="color:rgb(102,102,0);">.</span><span class="typ" style="color:rgb(102,0,102);">CheckTransaction</span><span class="pun" style="color:rgb(102,102,0);">())</span></code></li>
   <li class="L0"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">return</span><span class="pln" style="color:rgb(0,0,0);"> error</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="str" style="color:rgb(0,136,0);">"CheckBlock() : CheckTransaction failed"</span><span class="pun" style="color:rgb(102,102,0);">);</span></code></li>
   <li class="L1" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"></code></li>
   <li class="L2"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="com" style="color:rgb(136,0,0);">// Check proof of work matches claimed amount</span></code></li>
   <li class="L3" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="kwd" style="color:rgb(0,0,136);">if</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="typ" style="color:rgb(102,0,102);">CBigNum</span><span class="pun" style="color:rgb(102,102,0);">().</span><span class="typ" style="color:rgb(102,0,102);">SetCompact</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">nBits</span><span class="pun" style="color:rgb(102,102,0);">)</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">&gt;</span><span class="pln" style="color:rgb(0,0,0);"> bnProofOfWorkLimit</span><span class="pun" style="color:rgb(102,102,0);">)</span></code></li>
   <li class="L4"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">return</span><span class="pln" style="color:rgb(0,0,0);"> error</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="str" style="color:rgb(0,136,0);">"CheckBlock() : nBits below minimum work"</span><span class="pun" style="color:rgb(102,102,0);">);</span></code></li>
   <li class="L5" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="kwd" style="color:rgb(0,0,136);">if</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="typ" style="color:rgb(102,0,102);">GetHash</span><span class="pun" style="color:rgb(102,102,0);">()</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">&gt;</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="typ" style="color:rgb(102,0,102);">CBigNum</span><span class="pun" style="color:rgb(102,102,0);">().</span><span class="typ" style="color:rgb(102,0,102);">SetCompact</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">nBits</span><span class="pun" style="color:rgb(102,102,0);">).</span><span class="pln" style="color:rgb(0,0,0);">getuint256</span><span class="pun" style="color:rgb(102,102,0);">())</span></code></li>
   <li class="L6"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">return</span><span class="pln" style="color:rgb(0,0,0);"> error</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="str" style="color:rgb(0,136,0);">"CheckBlock() : hash doesn't match nBits"</span><span class="pun" style="color:rgb(102,102,0);">);</span></code></li>
   <li class="L7" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"></code></li>
   <li class="L8"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="com" style="color:rgb(136,0,0);">// Check merkleroot</span></code></li>
   <li class="L9" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="kwd" style="color:rgb(0,0,136);">if</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">hashMerkleRoot </span><span class="pun" style="color:rgb(102,102,0);">!=</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="typ" style="color:rgb(102,0,102);">BuildMerkleTree</span><span class="pun" style="color:rgb(102,102,0);">())</span></code></li>
   <li class="L0"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">return</span><span class="pln" style="color:rgb(0,0,0);"> error</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="str" style="color:rgb(0,136,0);">"CheckBlock() : hashMerkleRoot mismatch"</span><span class="pun" style="color:rgb(102,102,0);">);</span></code></li>
  </ol>
  <h1 style="font-size:2.25em;font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;line-height:1.2;color:rgb(51,51,51);border-bottom:1px solid rgb(238,238,238);text-align:left;"><a class="reference-link" style="background-position:0px 0px;color:rgb(65,131,196);"></a>根据区块前一区块进行处理</h1>
  <h2 style="font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;line-height:1.225;color:rgb(51,51,51);font-size:1.75em;border-bottom:1px solid rgb(238,238,238);text-align:left;"><a class="reference-link" style="background-position:0px 0px;color:rgb(65,131,196);"></a>如果前一区块不存在区块链中，则将前一区块加入孤立区块</h2>
  <p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;text-align:left;">此种情况，表示区块链出现分叉或者网络延迟导致的，则需要发送“getblocks”获取最长链中缺少的区块信息。</p>
  <pre class="prettyprint linenums prettyprinted" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;line-height:1.6;color:rgb(51,51,51);background:rgb(246,246,246);border-width:1px;border-style:solid;border-color:rgb(221,221,221);text-align:left;"></pre>
  <ol class="linenums" style="color:rgb(153,153,153);">
   <li class="L0"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="kwd" style="color:rgb(0,0,136);">if</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(!</span><span class="pln" style="color:rgb(0,0,0);">mapBlockIndex</span><span class="pun" style="color:rgb(102,102,0);">.</span><span class="pln" style="color:rgb(0,0,0);">count</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">pblock</span><span class="pun" style="color:rgb(102,102,0);">-&gt;</span><span class="pln" style="color:rgb(0,0,0);">hashPrevBlock</span><span class="pun" style="color:rgb(102,102,0);">))</span></code></li>
   <li class="L1" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pun" style="color:rgb(102,102,0);">{</span></code></li>
   <li class="L2"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> printf</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="str" style="color:rgb(0,136,0);">"ProcessBlock: ORPHAN BLOCK, prev=%s\n"</span><span class="pun" style="color:rgb(102,102,0);">,</span><span class="pln" style="color:rgb(0,0,0);"> pblock</span><span class="pun" style="color:rgb(102,102,0);">-&gt;</span><span class="pln" style="color:rgb(0,0,0);">hashPrevBlock</span><span class="pun" style="color:rgb(102,102,0);">.</span><span class="typ" style="color:rgb(102,0,102);">ToString</span><span class="pun" style="color:rgb(102,102,0);">().</span><span class="pln" style="color:rgb(0,0,0);">substr</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="lit" style="color:rgb(0,102,102);">0</span><span class="pun" style="color:rgb(102,102,0);">,</span><span class="lit" style="color:rgb(0,102,102);">14</span><span class="pun" style="color:rgb(102,102,0);">).</span><span class="pln" style="color:rgb(0,0,0);">c_str</span><span class="pun" style="color:rgb(102,102,0);">());</span></code></li>
   <li class="L3" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> mapOrphanBlocks</span><span class="pun" style="color:rgb(102,102,0);">.</span><span class="pln" style="color:rgb(0,0,0);">insert</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">make_pair</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">hash</span><span class="pun" style="color:rgb(102,102,0);">,</span><span class="pln" style="color:rgb(0,0,0);"> pblock</span><span class="pun" style="color:rgb(102,102,0);">));</span></code></li>
   <li class="L4"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> mapOrphanBlocksByPrev</span><span class="pun" style="color:rgb(102,102,0);">.</span><span class="pln" style="color:rgb(0,0,0);">insert</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">make_pair</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">pblock</span><span class="pun" style="color:rgb(102,102,0);">-&gt;</span><span class="pln" style="color:rgb(0,0,0);">hashPrevBlock</span><span class="pun" style="color:rgb(102,102,0);">,</span><span class="pln" style="color:rgb(0,0,0);"> pblock</span><span class="pun" style="color:rgb(102,102,0);">));</span></code></li>
   <li class="L5" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"></code></li>
   <li class="L6"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="com" style="color:rgb(136,0,0);">// Ask this guy to fill in what we're missing</span></code></li>
   <li class="L7" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">if</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">pfrom</span><span class="pun" style="color:rgb(102,102,0);">)</span></code></li>
   <li class="L8"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> pfrom</span><span class="pun" style="color:rgb(102,102,0);">-&gt;</span><span class="typ" style="color:rgb(102,0,102);">PushMessage</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="str" style="color:rgb(0,136,0);">"getblocks"</span><span class="pun" style="color:rgb(102,102,0);">,</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="typ" style="color:rgb(102,0,102);">CBlockLocator</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">pindexBest</span><span class="pun" style="color:rgb(102,102,0);">),</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="typ" style="color:rgb(102,0,102);">GetOrphanRoot</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">pblock</span><span class="pun" style="color:rgb(102,102,0);">));</span></code></li>
   <li class="L9" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">return</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">true</span><span class="pun" style="color:rgb(102,102,0);">;</span></code></li>
   <li class="L0"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pun" style="color:rgb(102,102,0);">}</span></code></li>
  </ol>
  <h2 style="font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;line-height:1.225;color:rgb(51,51,51);font-size:1.75em;border-bottom:1px solid rgb(238,238,238);text-align:left;"><a class="reference-link" style="background-position:0px 0px;color:rgb(65,131,196);"></a>如果前一区块不存在区块链中，则尝试接受区块</h2>
  <pre class="prettyprint linenums prettyprinted" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;line-height:1.6;color:rgb(51,51,51);background:rgb(246,246,246);border-width:1px;border-style:solid;border-color:rgb(221,221,221);text-align:left;"></pre>
  <ol class="linenums" style="color:rgb(153,153,153);">
   <li class="L0"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="kwd" style="color:rgb(0,0,136);">if</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(!</span><span class="pln" style="color:rgb(0,0,0);">pblock</span><span class="pun" style="color:rgb(102,102,0);">-&gt;</span><span class="typ" style="color:rgb(102,0,102);">AcceptBlock</span><span class="pun" style="color:rgb(102,102,0);">())</span></code></li>
   <li class="L1" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pun" style="color:rgb(102,102,0);">{</span></code></li>
   <li class="L2"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">delete</span><span class="pln" style="color:rgb(0,0,0);"> pblock</span><span class="pun" style="color:rgb(102,102,0);">;</span></code></li>
   <li class="L3" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">return</span><span class="pln" style="color:rgb(0,0,0);"> error</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="str" style="color:rgb(0,136,0);">"ProcessBlock() : AcceptBlock FAILED"</span><span class="pun" style="color:rgb(102,102,0);">);</span></code></li>
   <li class="L4"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pun" style="color:rgb(102,102,0);">}</span></code></li>
   <li class="L5" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="kwd" style="color:rgb(0,0,136);">delete</span><span class="pln" style="color:rgb(0,0,0);"> pblock</span><span class="pun" style="color:rgb(102,102,0);">;</span></code></li>
  </ol>
  <h3 style="font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;line-height:1.43;color:rgb(51,51,51);font-size:1.5em;text-align:left;"><a class="reference-link" style="background-position:0px 0px;color:rgb(65,131,196);"></a>接受区块</h3>
  <p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;text-align:left;">“接受区块”包含区块重复性检查，前一区块有效性区块，时间戳检查，工作量证明；当这些条件检查通过后，将区块写入磁盘并加入到区块链中。（加入到区块链具体在后续“比特币源码解读之共识”一文中介绍）</p>
  <pre class="prettyprint linenums prettyprinted" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;line-height:1.6;color:rgb(51,51,51);background:rgb(246,246,246);border-width:1px;border-style:solid;border-color:rgb(221,221,221);text-align:left;"></pre>
  <ol class="linenums" style="color:rgb(153,153,153);">
   <li class="L0"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="kwd" style="color:rgb(0,0,136);">bool</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="typ" style="color:rgb(102,0,102);">CBlock</span><span class="pun" style="color:rgb(102,102,0);">::</span><span class="typ" style="color:rgb(102,0,102);">AcceptBlock</span><span class="pun" style="color:rgb(102,102,0);">()</span></code></li>
   <li class="L1" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pun" style="color:rgb(102,102,0);">{</span></code></li>
   <li class="L2"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="com" style="color:rgb(136,0,0);">// Check for duplicate</span></code></li>
   <li class="L3" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="typ" style="color:rgb(102,0,102);">uint256</span><span class="pln" style="color:rgb(0,0,0);"> hash </span><span class="pun" style="color:rgb(102,102,0);">=</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="typ" style="color:rgb(102,0,102);">GetHash</span><span class="pun" style="color:rgb(102,102,0);">();</span></code></li>
   <li class="L4"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">if</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">mapBlockIndex</span><span class="pun" style="color:rgb(102,102,0);">.</span><span class="pln" style="color:rgb(0,0,0);">count</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">hash</span><span class="pun" style="color:rgb(102,102,0);">))</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="com" style="color:rgb(136,0,0);">// 当前区块重复性检查</span></code></li>
   <li class="L5" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">return</span><span class="pln" style="color:rgb(0,0,0);"> error</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="str" style="color:rgb(0,136,0);">"AcceptBlock() : block already in mapBlockIndex"</span><span class="pun" style="color:rgb(102,102,0);">);</span></code></li>
   <li class="L6"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"></code></li>
   <li class="L7" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="com" style="color:rgb(136,0,0);">// Get prev block index</span></code></li>
   <li class="L8"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="typ" style="color:rgb(102,0,102);">map</span><span class="pun" style="color:rgb(102,102,0);">&lt;</span><span class="typ" style="color:rgb(102,0,102);">uint256</span><span class="pun" style="color:rgb(102,102,0);">,</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="typ" style="color:rgb(102,0,102);">CBlockIndex</span><span class="pun" style="color:rgb(102,102,0);">*&gt;::</span><span class="typ" style="color:rgb(102,0,102);">iterator</span><span class="pln" style="color:rgb(0,0,0);"> mi </span><span class="pun" style="color:rgb(102,102,0);">=</span><span class="pln" style="color:rgb(0,0,0);"> mapBlockIndex</span><span class="pun" style="color:rgb(102,102,0);">.</span><span class="pln" style="color:rgb(0,0,0);">find</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">hashPrevBlock</span><span class="pun" style="color:rgb(102,102,0);">);</span></code></li>
   <li class="L9" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">if</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">mi </span><span class="pun" style="color:rgb(102,102,0);">==</span><span class="pln" style="color:rgb(0,0,0);"> mapBlockIndex</span><span class="pun" style="color:rgb(102,102,0);">.</span><span class="pln" style="color:rgb(0,0,0);">end</span><span class="pun" style="color:rgb(102,102,0);">())</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="com" style="color:rgb(136,0,0);">// 前一区块有效性检查</span></code></li>
   <li class="L0"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">return</span><span class="pln" style="color:rgb(0,0,0);"> error</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="str" style="color:rgb(0,136,0);">"AcceptBlock() : prev block not found"</span><span class="pun" style="color:rgb(102,102,0);">);</span></code></li>
   <li class="L1" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="typ" style="color:rgb(102,0,102);">CBlockIndex</span><span class="pun" style="color:rgb(102,102,0);">*</span><span class="pln" style="color:rgb(0,0,0);"> pindexPrev </span><span class="pun" style="color:rgb(102,102,0);">=</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(*</span><span class="pln" style="color:rgb(0,0,0);">mi</span><span class="pun" style="color:rgb(102,102,0);">).</span><span class="pln" style="color:rgb(0,0,0);">second</span><span class="pun" style="color:rgb(102,102,0);">;</span></code></li>
   <li class="L2"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"></code></li>
   <li class="L3" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="com" style="color:rgb(136,0,0);">// Check timestamp against prev </span></code></li>
   <li class="L4"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">if</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">nTime </span><span class="pun" style="color:rgb(102,102,0);">&lt;=</span><span class="pln" style="color:rgb(0,0,0);"> pindexPrev</span><span class="pun" style="color:rgb(102,102,0);">-&gt;</span><span class="typ" style="color:rgb(102,0,102);">GetMedianTimePast</span><span class="pun" style="color:rgb(102,102,0);">())</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="com" style="color:rgb(136,0,0);">// 时间戳检查</span></code></li>
   <li class="L5" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">return</span><span class="pln" style="color:rgb(0,0,0);"> error</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="str" style="color:rgb(0,136,0);">"AcceptBlock() : block's timestamp is too early"</span><span class="pun" style="color:rgb(102,102,0);">);</span></code></li>
   <li class="L6"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"></code></li>
   <li class="L7" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="com" style="color:rgb(136,0,0);">// Check proof of work</span></code></li>
   <li class="L8"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">if</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">nBits </span><span class="pun" style="color:rgb(102,102,0);">!=</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="typ" style="color:rgb(102,0,102);">GetNextWorkRequired</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">pindexPrev</span><span class="pun" style="color:rgb(102,102,0);">))</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="com" style="color:rgb(136,0,0);">// 工作量检查</span></code></li>
   <li class="L9" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">return</span><span class="pln" style="color:rgb(0,0,0);"> error</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="str" style="color:rgb(0,136,0);">"AcceptBlock() : incorrect proof of work"</span><span class="pun" style="color:rgb(102,102,0);">);</span></code></li>
   <li class="L0"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"></code></li>
   <li class="L1" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="com" style="color:rgb(136,0,0);">// Write block to history file</span></code></li>
   <li class="L2"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">unsigned</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="typ" style="color:rgb(102,0,102);">int</span><span class="pln" style="color:rgb(0,0,0);"> nFile</span><span class="pun" style="color:rgb(102,102,0);">;</span></code></li>
   <li class="L3" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">unsigned</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="typ" style="color:rgb(102,0,102);">int</span><span class="pln" style="color:rgb(0,0,0);"> nBlockPos</span><span class="pun" style="color:rgb(102,102,0);">;</span></code></li>
   <li class="L4"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">if</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(!</span><span class="typ" style="color:rgb(102,0,102);">WriteToDisk</span><span class="pun" style="color:rgb(102,102,0);">(!</span><span class="pln" style="color:rgb(0,0,0);">fClient</span><span class="pun" style="color:rgb(102,102,0);">,</span><span class="pln" style="color:rgb(0,0,0);"> nFile</span><span class="pun" style="color:rgb(102,102,0);">,</span><span class="pln" style="color:rgb(0,0,0);"> nBlockPos</span><span class="pun" style="color:rgb(102,102,0);">))</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="com" style="color:rgb(136,0,0);">// 区块写入磁盘中</span></code></li>
   <li class="L5" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">return</span><span class="pln" style="color:rgb(0,0,0);"> error</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="str" style="color:rgb(0,136,0);">"AcceptBlock() : WriteToDisk failed"</span><span class="pun" style="color:rgb(102,102,0);">);</span></code></li>
   <li class="L6"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">if</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(!</span><span class="typ" style="color:rgb(102,0,102);">AddToBlockIndex</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">nFile</span><span class="pun" style="color:rgb(102,102,0);">,</span><span class="pln" style="color:rgb(0,0,0);"> nBlockPos</span><span class="pun" style="color:rgb(102,102,0);">))</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="com" style="color:rgb(136,0,0);">// 加入到区块链中</span></code></li>
   <li class="L7" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">return</span><span class="pln" style="color:rgb(0,0,0);"> error</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="str" style="color:rgb(0,136,0);">"AcceptBlock() : AddToBlockIndex failed"</span><span class="pun" style="color:rgb(102,102,0);">);</span></code></li>
   <li class="L8"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"></code></li>
   <li class="L9" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">if</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">hashBestChain </span><span class="pun" style="color:rgb(102,102,0);">==</span><span class="pln" style="color:rgb(0,0,0);"> hash</span><span class="pun" style="color:rgb(102,102,0);">)</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="com" style="color:rgb(136,0,0);">// 如果该区块链式最长链，则广播消息</span></code></li>
   <li class="L0"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="typ" style="color:rgb(102,0,102);">RelayInventory</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="typ" style="color:rgb(102,0,102);">CInv</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">MSG_BLOCK</span><span class="pun" style="color:rgb(102,102,0);">,</span><span class="pln" style="color:rgb(0,0,0);"> hash</span><span class="pun" style="color:rgb(102,102,0);">));</span></code></li>
   <li class="L1" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"></code></li>
   <li class="L2"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">return</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">true</span><span class="pun" style="color:rgb(102,102,0);">;</span></code></li>
   <li class="L3" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pun" style="color:rgb(102,102,0);">}</span></code></li>
  </ol>
  <h3 style="font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;line-height:1.43;color:rgb(51,51,51);font-size:1.5em;text-align:left;"><a class="reference-link" style="background-position:0px 0px;color:rgb(65,131,196);"></a>处理孤立区块和当前区块的关系，并尝试接受孤立区块</h3>
  <pre class="prettyprint linenums prettyprinted" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;line-height:1.6;color:rgb(51,51,51);background:rgb(246,246,246);border-width:1px;border-style:solid;border-color:rgb(221,221,221);text-align:left;"></pre>
  <ol class="linenums" style="color:rgb(153,153,153);">
   <li class="L0"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="typ" style="color:rgb(102,0,102);">vector</span><span class="str" style="color:rgb(0,136,0);">&lt;uint256&gt;</span><span class="pln" style="color:rgb(0,0,0);"> vWorkQueue</span><span class="pun" style="color:rgb(102,102,0);">;</span></code></li>
   <li class="L1" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);">vWorkQueue</span><span class="pun" style="color:rgb(102,102,0);">.</span><span class="pln" style="color:rgb(0,0,0);">push_back</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">hash</span><span class="pun" style="color:rgb(102,102,0);">);</span></code></li>
   <li class="L2"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="kwd" style="color:rgb(0,0,136);">for</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="typ" style="color:rgb(102,0,102);">int</span><span class="pln" style="color:rgb(0,0,0);"> i </span><span class="pun" style="color:rgb(102,102,0);">=</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="lit" style="color:rgb(0,102,102);">0</span><span class="pun" style="color:rgb(102,102,0);">;</span><span class="pln" style="color:rgb(0,0,0);"> i </span><span class="pun" style="color:rgb(102,102,0);">&lt;</span><span class="pln" style="color:rgb(0,0,0);"> vWorkQueue</span><span class="pun" style="color:rgb(102,102,0);">.</span><span class="pln" style="color:rgb(0,0,0);">size</span><span class="pun" style="color:rgb(102,102,0);">();</span><span class="pln" style="color:rgb(0,0,0);"> i</span><span class="pun" style="color:rgb(102,102,0);">++)</span></code></li>
   <li class="L3" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pun" style="color:rgb(102,102,0);">{</span></code></li>
   <li class="L4"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="typ" style="color:rgb(102,0,102);">uint256</span><span class="pln" style="color:rgb(0,0,0);"> hashPrev </span><span class="pun" style="color:rgb(102,102,0);">=</span><span class="pln" style="color:rgb(0,0,0);"> vWorkQueue</span><span class="pun" style="color:rgb(102,102,0);">[</span><span class="pln" style="color:rgb(0,0,0);">i</span><span class="pun" style="color:rgb(102,102,0);">];</span></code></li>
   <li class="L5" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">for</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="typ" style="color:rgb(102,0,102);">multimap</span><span class="pun" style="color:rgb(102,102,0);">&lt;</span><span class="typ" style="color:rgb(102,0,102);">uint256</span><span class="pun" style="color:rgb(102,102,0);">,</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="typ" style="color:rgb(102,0,102);">CBlock</span><span class="pun" style="color:rgb(102,102,0);">*&gt;::</span><span class="typ" style="color:rgb(102,0,102);">iterator</span><span class="pln" style="color:rgb(0,0,0);"> mi </span><span class="pun" style="color:rgb(102,102,0);">=</span><span class="pln" style="color:rgb(0,0,0);"> mapOrphanBlocksByPrev</span><span class="pun" style="color:rgb(102,102,0);">.</span><span class="pln" style="color:rgb(0,0,0);">lower_bound</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">hashPrev</span><span class="pun" style="color:rgb(102,102,0);">);</span></code></li>
   <li class="L6"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> mi </span><span class="pun" style="color:rgb(102,102,0);">!=</span><span class="pln" style="color:rgb(0,0,0);"> mapOrphanBlocksByPrev</span><span class="pun" style="color:rgb(102,102,0);">.</span><span class="pln" style="color:rgb(0,0,0);">upper_bound</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">hashPrev</span><span class="pun" style="color:rgb(102,102,0);">);</span></code></li>
   <li class="L7" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">++</span><span class="pln" style="color:rgb(0,0,0);">mi</span><span class="pun" style="color:rgb(102,102,0);">)</span></code></li>
   <li class="L8"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">{</span></code></li>
   <li class="L9" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="typ" style="color:rgb(102,0,102);">CBlock</span><span class="pun" style="color:rgb(102,102,0);">*</span><span class="pln" style="color:rgb(0,0,0);"> pblockOrphan </span><span class="pun" style="color:rgb(102,102,0);">=</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(*</span><span class="pln" style="color:rgb(0,0,0);">mi</span><span class="pun" style="color:rgb(102,102,0);">).</span><span class="pln" style="color:rgb(0,0,0);">second</span><span class="pun" style="color:rgb(102,102,0);">;</span></code></li>
   <li class="L0"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">if</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">pblockOrphan</span><span class="pun" style="color:rgb(102,102,0);">-&gt;</span><span class="typ" style="color:rgb(102,0,102);">AcceptBlock</span><span class="pun" style="color:rgb(102,102,0);">())</span><span class="pln" style="color:rgb(0,0,0);"> </span><span class="com" style="color:rgb(136,0,0);">// 尝试接受孤立区块</span></code></li>
   <li class="L1" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> vWorkQueue</span><span class="pun" style="color:rgb(102,102,0);">.</span><span class="pln" style="color:rgb(0,0,0);">push_back</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">pblockOrphan</span><span class="pun" style="color:rgb(102,102,0);">-&gt;</span><span class="typ" style="color:rgb(102,0,102);">GetHash</span><span class="pun" style="color:rgb(102,102,0);">());</span></code></li>
   <li class="L2"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> mapOrphanBlocks</span><span class="pun" style="color:rgb(102,102,0);">.</span><span class="pln" style="color:rgb(0,0,0);">erase</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">pblockOrphan</span><span class="pun" style="color:rgb(102,102,0);">-&gt;</span><span class="typ" style="color:rgb(102,0,102);">GetHash</span><span class="pun" style="color:rgb(102,102,0);">());</span></code></li>
   <li class="L3" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="kwd" style="color:rgb(0,0,136);">delete</span><span class="pln" style="color:rgb(0,0,0);"> pblockOrphan</span><span class="pun" style="color:rgb(102,102,0);">;</span></code></li>
   <li class="L4"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> </span><span class="pun" style="color:rgb(102,102,0);">}</span></code></li>
   <li class="L5" style="background:rgb(238,238,238);"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pln" style="color:rgb(0,0,0);"> mapOrphanBlocksByPrev</span><span class="pun" style="color:rgb(102,102,0);">.</span><span class="pln" style="color:rgb(0,0,0);">erase</span><span class="pun" style="color:rgb(102,102,0);">(</span><span class="pln" style="color:rgb(0,0,0);">hashPrev</span><span class="pun" style="color:rgb(102,102,0);">);</span></code></li>
   <li class="L6"><code class="lang-cpp" style="font-family:'YaHei Consolas Hybrid', Consolas, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Helvetica, monospace, monospace;color:inherit;background:0px 0px;border:none;line-height:inherit;"><span class="pun" style="color:rgb(102,102,0);">}</span></code></li>
  </ol>
  <p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;text-align:left;">上一篇：&nbsp;<a href="http://www.360bchain.com/article/123.html" rel="nofollow" title="比特币源码解读之选币" style="background-position:0px 0px;color:rgb(65,131,196);">比特币源码解读之选币</a></p>
  <p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;text-align:left;">下一篇：<a href="http://www.360bchain.com/article/149.html" rel="nofollow" title="比特币源码解读之工作量证明" style="background-position:0px 0px;color:rgb(65,131,196);">比特币源码解读之工作量证明</a></p>
  <p style="color:rgb(51,51,51);font-family:'Microsoft YaHei', Helvetica, 'Meiryo UI', 'Malgun Gothic', 'Segoe UI', 'Trebuchet MS', Monaco, monospace, Tahoma, STXihei, '华文细黑', STHeiti, 'Helvetica Neue', 'Droid Sans', 'wenquanyi micro hei', FreeSans, Arimo, Arial, SimSun, '宋体', Heiti, '黑体', sans-serif;font-size:14px;text-align:left;"></p>
  <p>版权声明：B链网原创，严禁修改。转载请注明作者和原文链接</p>
  <p></p>
  <p style="background-color:rgb(255,255,255);">作者：雨后的蚊子</p>
  <p style="background-color:rgb(255,255,255);">原文链接：<a href="http://www.360bchain.com/article/130.html" rel="nofollow" style="font-size:14px;text-align:left;background-position:0px 0px;color:rgb(65,131,196);">http://www.360bchain.com/article/130.html</a></p> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/Tostick/article/details/80398204,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/Tostick/article/details/80398204,&quot;}">阅读更多</a> 
</div>
      <br />
        <a href="https://blog.uzzz.org/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://blog.uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://blog.uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    
    <script>
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        }
        else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
    </script>

  </body>
</html>
